<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>STOMP Test Client</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-2.2.4.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.4.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
  <style>
    /* 어두운 블루 계열 그라데이션 배경 */
    body {
      background: linear-gradient(135deg, #0d1a2a, #0a1128, #010101);
      background-size: cover;
      color: #ffffff;
    }
    .container {
      max-width: 900px;
    }
    .card {
      background-color: #1e1e1e;
      border: 1px solid #333;
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #333;
      border-bottom: 1px solid #444;
    }
    .card-header h4 {
      margin: 0;
    }
    /* 입력 필드 다크 모드 스타일 (입력 텍스트 색상은 #ccc로 적용) */
    .form-control {
      background-color: #343a40;
      border: 1px solid #555;
      color: #ccc;
    }
    .form-control::placeholder {
      color: #bbb;
    }
    /* 포커스 및 호버 시 테두리를 오렌지(#ffa500)로 강조 */
    .form-control:focus,
    .form-control:hover {
      background-color: #343a40 !important;
      color: #ccc !important;
      border-color: #ffa500;
      box-shadow: none;
    }
    /* disabled 상태에서도 동일한 스타일 유지 */
    .form-control:disabled,
    .form-control[disabled] {
      background-color: #343a40 !important;
      color: #ccc !important;
      opacity: 1;
    }
    /* 버튼 스타일 (다크 모드) */
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
    .btn-secondary {
      background-color: #6c757d;
      border-color: #6c757d;
    }
    .btn-secondary:hover {
      background-color: #5c636a;
      border-color: #545b62;
    }
    .btn-success {
      background-color: #198754;
      border-color: #198754;
    }
    .btn-success:hover {
      background-color: #157347;
      border-color: #146c43;
    }
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }
    .btn-warning {
      background-color: #ffc107;
      border-color: #ffc107;
      color: #000;
    }
    .btn-warning:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }
    /* 수신 메시지 영역: 검은 배경, 흰색 텍스트 */
    #messageBox {
      height: 300px;
      overflow-y: auto;
      background-color: #000;
      color: #fff;
      padding: 1rem;
    }
    .subscription-form {
      margin-bottom: 10px;
    }
  </style>
  <script type="text/javascript">
    let stompClient; // 전역 STOMP 클라이언트
    let subscriptions = {}; // 구독 정보를 저장할 객체

    // 연결 상태를 업데이트하는 함수
    function updateConnectionStatus(isConnected, info) {
      const statusBox = $('#connectionStatus');
      if (isConnected) {
        statusBox.html(`<div class="alert alert-success mb-0">Connected: ${info}</div>`);
      } else {
        statusBox.html(`<div class="alert alert-danger mb-0">
                          Connection failed: 
                          <pre class="mb-0" style="white-space: pre-wrap; background: transparent; border: none;">
${info}</pre>
                        </div>`);
      }
    }

    // 사전 인증 함수: 토큰을 REST API 통해 검증 (백엔드 주소를 절대 URL로 지정)
    function preAuthenticate(token, onSuccess, onError) {
      axios.get('http://localhost:8080/chat/auth/validate-token', {
        headers: { "access": token }
      })
      .then(function(response) {
        onSuccess(response.data);
      })
      .catch(function(error) {
        let errorMsg = error.response && error.response.data ? error.response.data : error.message;
        onError(errorMsg);
      });
    }

    // 토큰 테스트 함수: 토큰 검증 API를 호출하여 결과를 출력
    function testToken() {
      let token = $('#accessHeader').val().trim();
      if (!token) {
        alert("먼저 access 토큰을 입력하세요!");
        return;
      }
      preAuthenticate(token,
        function(successMsg) {
          $('#tokenTestResult').text("테스트 성공: " + successMsg).removeClass("text-danger").addClass("text-success");
        },
        function(errorMsg) {
          $('#tokenTestResult').text("테스트 실패: " + errorMsg).removeClass("text-success").addClass("text-danger");
        }
      );
    }

    // 웹소켓 연결 함수
    function connectWebSocket() {
      let accessToken = $('#accessHeader').val().trim();
      if (!accessToken) {
        alert("먼저 access 토큰을 입력하세요!");
        return;
      }
      preAuthenticate(accessToken,
        function(successMsg) {
          console.log("Token validated: " + successMsg);
          let url = $('#websocketUrl').val().trim();
          if (!url) {
            url = "ws://localhost:8080/ws";
            $('#websocketUrl').val(url);
          }
          if (url.startsWith("ws://") || url.startsWith("wss://")) {
            stompClient = Stomp.client(url);
          } else {
            const socket = new SockJS(url);
            stompClient = Stomp.over(socket);
          }
          stompClient.connect({"access": accessToken}, stompConnectHandler, stompErrorHandler);
        },
        function(errorMsg) {
          updateConnectionStatus(false, errorMsg);
        }
      );
    }

    // 연결 성공 핸들러
    function stompConnectHandler(frame) {
      console.log('Connected: ' + frame);
      updateConnectionStatus(true, frame);
      $("#websocketUrl").prop("disabled", true);
    }

    // 연결 오류 핸들러
    function stompErrorHandler(errorFrame) {
      console.error('STOMP error:', errorFrame);
      let errorContent = "";
      if (errorFrame && errorFrame.body) {
        errorContent = errorFrame.body;
      } else if (typeof errorFrame === "object") {
        errorContent = JSON.stringify(errorFrame, null, 2);
      } else {
        errorContent = errorFrame;
      }
      updateConnectionStatus(false, errorContent);
    }

    // 웹소켓 연결 해제 함수
    function disconnectWebSocket() {
      if (stompClient !== null) {
        stompClient.disconnect(function() {
          console.log("Disconnected");
          updateConnectionStatus(false, "Disconnected");
          stompClient = null;
          $("#websocketUrl").prop("disabled", false);
        });
      } else {
        alert("현재 연결되어 있지 않습니다!");
      }
    }

    // 구독 관련 함수들
    function subscribeToPath(path) {
      if (!stompClient) {
        alert("먼저 웹소켓을 연결하세요!");
        return;
      }
      if (!path) {
        alert("구독할 경로를 입력하세요!");
        return;
      }
      let accessToken = $('#accessHeader').val().trim();
      const subscription = stompClient.subscribe(path, function(data) {
        displayMessage(data.body);
      }, {"access": accessToken});
      subscriptions[path] = subscription;
    }

    function unsubscribeFromPath(path) {
      if (subscriptions[path]) {
        subscriptions[path].unsubscribe();
        delete subscriptions[path];
        console.log(`Unsubscribed from ${path}`);
      }
    }

    function displayMessage(messageData) {
      const messageBox = $('#messageBox');
      messageBox.append(`<div class="mb-2" style="color: #fff;">${messageData}</div>`);
      messageBox.scrollTop(messageBox[0].scrollHeight);
    }

    $(function () {
      $('#connectBtn').click(connectWebSocket);
      $('#disconnectBtn').click(disconnectWebSocket);
      $('#clearMessagesBtn').click(function () {
        $('#messageBox').html('');
      });
      $('#addSubscriptionBtn').click(function () {
        const subscriptionCount = $('#subscriptionList .subscription-form').length;
        const subscriptionForm = `
          <div class="input-group subscription-form mb-3" id="subscription-${subscriptionCount}">
            <input type="text" class="form-control" placeholder="SUB PATH" id="path-${subscriptionCount}" />
            <button class="btn btn-primary subscribeBtn">구독</button>
            <button class="btn btn-secondary cancelSubscriptionBtn">취소</button>
            <button class="btn btn-danger unsubscribeBtn" style="display: none;">해제</button>
          </div>`;
        $('#subscriptionList').append(subscriptionForm);
      });
      $(document).on('click', '.subscribeBtn', function () {
        const inputField = $(this).siblings('input');
        const path = inputField.val().trim();
        if (path === "") {
          alert("구독할 경로를 입력하세요!");
          return;
        }
        subscribeToPath(path);
        inputField.prop('disabled', true);
        $(this).prop('disabled', true).hide();
        $(this).siblings('.cancelSubscriptionBtn').hide();
        $(this).siblings('.unsubscribeBtn').show();
      });
      $(document).on('click', '.unsubscribeBtn', function () {
        const inputField = $(this).siblings('input');
        const path = inputField.val().trim();
        unsubscribeFromPath(path);
        inputField.prop('disabled', false);
        $(this).siblings('.subscribeBtn').prop('disabled', false).show();
        $(this).siblings('.cancelSubscriptionBtn').show();
        $(this).hide();
      });
      $(document).on('click', '.cancelSubscriptionBtn', function () {
        const subscribeBtn = $(this).siblings('.subscribeBtn');
        if (subscribeBtn.prop('disabled')) {
          if (confirm("이미 구독 중입니다. 구독을 취소하고 폼을 제거하시겠습니까?")) {
            const inputField = $(this).siblings('input');
            const path = inputField.val().trim();
            unsubscribeFromPath(path);
            $(this).closest('.subscription-form').remove();
          }
        } else {
          $(this).closest('.subscription-form').remove();
        }
      });
      $('#sendBtn').click(function () {
        if (!stompClient) {
          alert("먼저 웹소켓을 연결하세요!");
          return;
        }
        const destinationPath = $('#destinationPath').val().trim();
        let accessToken = $('#accessHeader').val().trim();
        const messageJson = $('#message').val().trim();
        if (!destinationPath) {
          alert("전송할 목적지를 입력하세요!");
          return;
        }
        if (!messageJson) {
          alert("전송할 메시지를 입력하세요!");
          return;
        }
        try {
          const message = JSON.parse(messageJson);
          stompClient.send(destinationPath, {"access": accessToken}, JSON.stringify(message));
        } catch (error) {
          alert('유효한 JSON을 입력하세요!');
        }
      });
      // 토큰 테스트 버튼 클릭 이벤트 바인딩
      $('#testTokenBtn').click(testToken);
    });
  </script>
</head>
<body>
  <div class="container my-4">
    <!-- Token 입력 카드 (맨 위) -->
    <div class="card mb-3">
      <div class="card-header">
        <h4>Access Token 입력</h4>
      </div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col">
            <input type="text" id="accessHeader" class="form-control" placeholder="access 토큰 값을 입력하세요">
          </div>
          <div class="col-auto">
            <button id="testTokenBtn" class="btn btn-info">토큰 테스트</button>
          </div>
        </div>
        <!-- 토큰 테스트 결과 출력 영역 -->
        <div class="mt-2">
          <span id="tokenTestResult"></span>
        </div>
      </div>
    </div>
    <!-- Connection Card -->
    <div class="card">
      <div class="card-header">
        <h4>웹소켓 연결</h4>
      </div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-8">
            <input type="text" id="websocketUrl" class="form-control" placeholder="ws://localhost:8080/ws" value="ws://localhost:8080/ws">
          </div>
          <div class="col-md-2">
            <button id="connectBtn" class="btn btn-primary w-100">연결</button>
          </div>
          <div class="col-md-2">
            <button id="disconnectBtn" class="btn btn-warning w-100">해제</button>
          </div>
        </div>
        <!-- 연결 상태 및 에러 프레임 메시지 표시 영역 -->
        <div class="mt-3" id="connectionStatus"></div>
      </div>
    </div>
    <!-- Subscription Card -->
    <div class="card">
      <div class="card-header">
        <h4>구독 관리</h4>
      </div>
      <div class="card-body">
        <div id="subscriptionList"></div>
        <button id="addSubscriptionBtn" class="btn btn-secondary">구독 추가</button>
      </div>
    </div>
    <!-- Send Message Card -->
    <div class="card">
      <div class="card-header">
        <h4>메시지 전송</h4>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <label for="destinationPath" class="form-label">목적지 경로:</label>
          <input type="text" id="destinationPath" class="form-control" placeholder="/app/send/{UUID}" value="/app/send/{UUID}">
        </div>
        <div class="mb-3">
          <label for="message" class="form-label">메시지 (JSON 형식):</label>
          <textarea id="message" class="form-control" style="height:170px;" placeholder='{"type": "CHAT", "content": "전송할 메시지", "sender": "발신자명"}'></textarea>
        </div>
        <button id="sendBtn" class="btn btn-success w-100">전송</button>
      </div>
    </div>
    <!-- Messages Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0">수신 메시지</h4>
        <button id="clearMessagesBtn" class="btn btn-secondary btn-sm">지우기</button>
      </div>
      <div class="card-body p-0">
        <div id="messageBox"></div>
      </div>
    </div>
  </div>
</body>
</html>
